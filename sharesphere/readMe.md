## 组成架构

<img src="C:\Users\Administrator\AppData\Local\YNote\data\m13276603969@163.com\f959d2c3467c40e49b5a551556c2496d\clipboard.png" alt="img" style="zoom:50%;" />



## 索引

### 为什么使用索引？

如果不使用索引，那么对数据的查找只有一种办法，即全表扫描，当数据量较小时，将分批数据整块的加载进内存速度较快，当数据量大时，如果还是用全表扫描必然无法保证性能。



### 可以作为索引的数据结构

- 二分查找数，平衡树，红黑树
- B 树，B+树
- hash

### B树与B+ 树

#### B树(m 阶)

- 根节点至少包含两个字节点
- 树中每个节点走多含有m个子节点
- 除根节点和叶子节点外，其他每个节点至少有ceil(m/2)个节点
- 所有叶子节点都位于同一层
- 对于一个非根非叶子节点满足如下条件
  - 至少含有[ceil(m/2-1),m-1]个数据，且对于i<j 有k_i<k_j
  - 节点的数量是指针数量-1
  - 指针指向的子树的所有值均大于k_i-1，小于k_i 

#### B+ 树(m 阶)

与B 树不同的是

- 叶子节点都有指向下一个叶子节点的指针
- 非叶子节点的子节点指针与关键字个数相同
- 所有的关键字都在叶子节点上出现
- 非叶子结点的子树指针P[i]，指向关键字值属于[K[i], K[i+1])的子树

mysql 对B+ 树做了改造即，将叶子节点的指针改为双向指针，且维护了指向头与尾的指针

#### B+ 数的阶数与存储的数据

由于操作系统的页为16K，那么一页上存储的数据为16K/(索引+指针) 的 字典数据，而mysql 默认树的高度3

值得注意的是存储时会将String 转为ASCII 码存储，所以字符串比数字占用更多的空间，且比较次数更多。

#### Hash 索引

mysql 除了B+ 树索引还支持hash 索引，建立方式如下

```
ALTER TABLE `test`.`testtb` ADD UNIQUE INDEX `index_value`(`value`) USING HASH;
```

### 为何使用B+ 树而不使用hash

hash 结构 在hash 碰撞的情况下，查找效率不均匀，最坏可能要查节点个数次，而且不支持范围查询。而b 树 可以通过二分查找等优化，mysql 对b+ 树结构做了优化，底层是双箭头的指针，且表含有其实位置的指针引用。

### 聚簇索引和稀疏索引

#### 聚簇索引

mysql 中叶子节点含有所有列的索引，其生成规则如下

- 如果存在主键，则使用主键建立聚簇索引
- 如果主键不存在但是存在唯一索引，则使用唯一索引建立聚簇索引
- 主键和唯一索引都不存在则mysql 会创建默认的聚簇索引

#### 稀疏索引

叶子节点存储的是聚簇索引中的关键字。通常情况下非主键都是稀疏索引。

#### 回表

由于稀疏索引不存储全部的列，如果在稀疏索引中不能拿到所有的列，此时就需要使用关键字的值，再次查询聚簇索引得到所有列，这个过程叫做回表。

#### 为何聚簇索引不存储所有列

1.节约存储

2.数据一致性，修改数据时只修改聚簇索引，而不需要将稀疏索引也修改一遍，减少两次操作可能带来的数据不一致，如通过主键和其他索引查找出的数据不一样。

### 复合索引与最左匹配原则

#### 复合索引

使用多个列建立的索引也被称为复合索引

```
ALTER TABLE `test`.`testtb` ADD UNIQUE INDEX `index1`(`value`, `name`);
```

在空间允许的情况下，符合索引要尽量保护多的字段,因为在查询时如果可以在稀疏索引中找到需要的所有列，那么就不需要再次回表。从而优化查找效率。

#### 最左匹配原则

mysql 在建立索引的时候如，a,b,c, mysql 会将abc 进行拼接建立索引，即先保证a 有序，然后再a 有序的基础上保证b 有序，a,b 有序的情况下保证c 有序，如果直接查找b ,或者c 由于是树排序，b 本身无序，此时无法走索引，即树的有序性与mysql 建立索引的机制是最左匹配原则的成因。

### 索引下推

索引下推(Index Condition Pushdown)简称ICP ,是数据库为了减少回表操作所作的优化，既然是为了减少回表，那么主键查询和多表查询用不到索引下推。例子如下 对于联合索引a,b,c ，当我们使用a like 'amb%' b = 'hot' 时，mysql 会将a 从复合索引中查寻到的节点进行筛选，即选出b=hot 的数据然后回表，而不是先回表后筛选出b=hot 的数据。此外，范围查找无法使用索引下推。

### 为何使用整形递增主键

空间层面，